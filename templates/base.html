<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#f5f5f5"> <!-- Barva z√°hlav√≠ prohl√≠≈æeƒçe v mobiln√≠ch za≈ô√≠zen√≠ch -->
    <meta name="format-detection" content="telephone=no"> <!-- Zabr√°n√≠ automatick√©mu form√°tov√°n√≠ telefonn√≠ch ƒç√≠sel -->
    <meta name="mobile-web-app-capable" content="yes"> <!-- Pro mo≈ænost p≈ôid√°n√≠ na plochu jako aplikace -->
    <meta name="apple-mobile-web-app-capable" content="yes"> <!-- Pro iOS za≈ô√≠zen√≠ -->
    <title>{% block title %}Hejbni kostrou!{% endblock %}</title>

    <!-- Zmƒõnƒõn√Ω odkaz na CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">

    <!-- P≈ôid√°n√≠ odkazu na favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">

    <!-- JavaScript soubory - d≈Øle≈æit√© po≈ôad√≠ -->
    <script src="{{ url_for('static', filename='js/skolni_rok.js') }}"></script>
    <script src="{{ url_for('static', filename='js/student_performance.js') }}"></script>
</head>

<body id="{% block body_id %}{% endblock %}">

    <!-- üîπ ≈†koln√≠ rok v prav√©m horn√≠m rohu -->
    <div class="skolni-rok">
        Aktu√°ln√≠ ≈°koln√≠ rok: {{ session.get('vybrany_skolni_rok', 'Nen√≠ nastaven') }}
    </div>

    <!-- üîπ Logo ‚ÄûDom≈Ø" -->
    <div class="logo-home">
        <a href="{{ url_for('home') }}">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Dom≈Ø">
        </a>
    </div>

    <!-- P≈ôidejte toto do <body> hned za hlaviƒçku -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="flash-messages">
        {% for category, message in messages %}
        <div class="flash-message {{ category }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <!-- üîπ Hlavn√≠ obsah str√°nky -->
    <div class="page-wrapper">
        <div class="container">
            {% block content %}{% endblock %}
        </div>
    </div>

    <!-- ‚úÖ Spoleƒçn√© funkce -->
    <script>
        /**
         * Funkce pro urƒçen√≠ aktu√°ln√≠ho ≈°koln√≠ho roku.
         * @returns {string} ≈†koln√≠ rok ve form√°tu "YYYY/YYYY+1"
         */
        function getDefaultSkolniRok() {
            return "2025/2026";
        }

        /**
         * Synchronizuje ≈°koln√≠ rok mezi localStorage a session na serveru.
         * @param {string} rok - ≈†koln√≠ rok ve form√°tu "YYYY/YYYY+1"
         * @returns {Promise} V√Ωsledek synchronizace
         */
        function synchronizovatRok(rok) {
            return fetch("/synchronizovat_rok", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ rok: rok })
            }).catch(error => console.error("Chyba synchronizace roku:", error));
        }

        /**
         * Aktualizuje UI hodnoty ≈°koln√≠ho roku.
         * @param {string} rok - ≈†koln√≠ rok ve form√°tu "YYYY/YYYY+1"
         */
        function aktualizovatUIRoku(rok) {
            // Aktualizujeme text roku v UI
            const skolniRokText = document.getElementById("skolni-rok-text");
            if (skolniRokText) {
                skolniRokText.textContent = rok;
            }

            // Vybereme spr√°vn√Ω rok v dropdown menu, pokud existuje
            const skolniRokSelect = document.getElementById("skolniRok");
            if (skolniRokSelect) {
                skolniRokSelect.value = rok;
            }
        }

        // Inicializace p≈ôi naƒçten√≠ str√°nky
        document.addEventListener("DOMContentLoaded", function () {
            // Synchronizace localStorage a session p≈ôi naƒçten√≠ str√°nky
            const ulozenySkolniRok = localStorage.getItem("skolniRok");
            if (ulozenySkolniRok) {
                aktualizovatUIRoku(ulozenySkolniRok);
                synchronizovatRok(ulozenySkolniRok);
            } else {
                // Pokud rok nen√≠ v localStorage, pou≈æijeme v√Ωchoz√≠ hodnotu
                let defaultRok = getDefaultSkolniRok();
                localStorage.setItem("skolniRok", defaultRok);
                aktualizovatUIRoku(defaultRok);
                synchronizovatRok(defaultRok);
            }

            console.log("üìÖ Nastaven√Ω ≈°koln√≠ rok:", localStorage.getItem("skolniRok"));

            // Event listener pro zmƒõnu ≈°koln√≠ho roku
            const skolniRokSelect = document.getElementById("skolniRok");
            if (skolniRokSelect) {
                skolniRokSelect.addEventListener("change", function () {
                    const vybranyRok = this.value;

                    // Zobrazen√≠ potvrzovac√≠ho mod√°ln√≠ho okna
                    if (confirm(`Chcete zmƒõnit ≈°koln√≠ rok na ${vybranyRok}?`)) {
                        localStorage.setItem("skolniRok", vybranyRok);
                        aktualizovatUIRoku(vybranyRok);

                        // Synchronizace se serverem
                        synchronizovatRok(vybranyRok)
                            .then(response => {
                                if (response && response.ok) {
                                    return response.json();
                                }
                                throw new Error('Neplatn√° odpovƒõƒè serveru');
                            })
                            .then(data => {
                                if (data.message) {
                                    alert(data.message);
                                }
                                // Obnoven√≠ str√°nky podle odpovƒõdi serveru nebo v≈ædy
                                window.location.reload();
                            })
                            .catch(error => {
                                console.error("Chyba p≈ôi synchronizaci roku:", error);
                            });
                    }
                });
            }

            // Optimalizace pro dotykov√© za≈ô√≠zen√≠
            const today = new Date();
            document.body.setAttribute('data-datum', today.toLocaleDateString('cs-CZ'));

            // Zji≈°tƒõn√≠, zda jde o dotykov√© za≈ô√≠zen√≠
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

            if (isTouchDevice) {
                // P≈ôid√°n√≠ t≈ô√≠dy k tƒõlu dokumentu pro CSS √∫pravy
                document.body.classList.add('touch-device');

                // P≈ôizp≈Øsoben√≠ input≈Ø pro numerick√© hodnoty
                const numericInputs = document.querySelectorAll('.discipline-table input, .bonus-table input, .penalty-table input');
                numericInputs.forEach(input => {
                    // Pro numerick√© inputy nastav√≠me numerickou kl√°vesnici
                    if (input.type === 'text' && !input.hasAttribute('pattern')) {
                        input.setAttribute('inputmode', 'decimal');
                    }
                });

                // Obalen√≠ tabulek pro horizont√°ln√≠ scrollov√°n√≠
                const tables = document.querySelectorAll('.discipline-table, .bonus-table, .penalty-table, .grading-table, .student-info-table');
                tables.forEach(table => {
                    // Pokud tabulka je≈°tƒõ nen√≠ v kontejneru pro scrollov√°n√≠
                    if (!table.parentElement.classList.contains('table-container')) {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'table-container';
                        table.parentNode.insertBefore(wrapper, table);
                        wrapper.appendChild(table);
                    }
                });
            }
        });
    </script>

    <!-- P≈ôid√°n JavaScript pro mod√°ln√≠ okna -->
    <script src="{{ url_for('static', filename='js/components/modals.js') }}"></script>
</body>

</html>